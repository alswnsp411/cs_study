# 4-way Handshake

클라이언트와 서버가 데이터 통신이 종료된 이후에 해당 연결을 끊는 과정(세션 종료)으로, 양쪽 호스트 모두 그 주체가 될 수 있으며, 3-way Handshake와 마찬가지로 TCP 헤더의 플래그가 사용됨

![Untitled](https://velog.velcdn.com/images%2Fnnnyeong%2Fpost%2F9943de2b-96d8-4e63-b9cc-46c1a89e20a3%2Fimage.png)

[사진 출처: https://velog.io/@nnnyeong/Network-TCP-3-way-4-way-Handshake]

- **과정**

  1. 클라이언트는 서버에게 FIN 플래그를 설정한 패킷을 서버에 전송

     > **FIN(FINISH) 플래그**
     >
     > 세션 연결을 종료시킬 때 사용되며 더이상 전송할 데이터가 없음을 나타냄

     - FIN_WAIT 상태:

  2. 서버는 클라이언트에게 ACK 응답 패킷 전송
  3. 서버는 소켓을 해제하고 통신 종료를 의미하는 FIN 패킷을 클라이언트에 전송

     > **소켓**
     >
     > 프로토콜, IP주소, 포트로 정의되며, 네트워크 상의 프로세스 간의 통신의 종착점임. 대부분의 통신은 인터넷 프로토콜을 기반으로 하기에 대부분의 네트워크 소켓은 인터넷 소켓임(크게 UDP프로토콜을 사용하는 경우와 TCP프로토콜을 사용하는 경우로 나눌 수 있음)

  4. 클라이언트는 서버에게 ACK 응답 패킷 전송

     > **연결을 끊는 주체의 TIME-WAIT**
     >
     > 연결을 끊는 FIN를 보내는 엔드포인트가 마지막 ACK를 수신자에게 보낸 후 TIME-WAIT 상태에 빠지는 이유는?
     >
     > TIME_WAIT: 수신자로부터 FIN를 수신하더라도 일정시간(디폴트 240초) 동안 세션을 남겨놓고 잉여 패킷을 기다리는 과정으로, 일정시간이 지나면 세션을 만료시키고 연결을 종료하며 CLOSE 상태로 변화
     >
     > - 수신자가 FIN를 전송하기 전에 전송한 패킷(ex. 마지막으로 세션을 종료하기 위한 과정에서 보내지는 데이터)이 라우팅 지연이나 패킷 유실로 인한 재전송 등으로 인해 FIN 패킷보다 늦게 도착하는 경우가 생기는 상황에 대비 가능
     > - 수신자가 ACK 수신에 실패하면 수신자는 송신자에게 다시 한번 FIN를 송신하게 됨 ⇒ TIME-WAIT 상태 없이 통신을 종료하게 된다면 수신자는 정상적인 소켓 종료를 행하지 못할 것임

  > **RST**(**RESET) 플래그**
  > TCP 연결을 강제 종료할 때 사용되는 플래그로, 비정상적인 세션 연결을 끊어낼 때 설정함. 악성코드가 감지된 경우, 자원 부족으로 인한 자원 할당을 해제해야 하는 경우, TCP 연결에 장애가 생긴 경우 사용될 수 있음
